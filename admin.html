<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel de Administraci√≥n - PuntoAlmacen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Incluir SDK de Parse -->
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <style>
    /* Estilos generales */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    /* Pantalla de Login */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #25D366, #128C7E);
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-logo h2 {
      color: #25D366;
      margin-bottom: 5px;
    }

    .login-form .form-group {
      margin-bottom: 20px;
    }

    .login-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .login-form input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      background: #25D366;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-btn:hover {
      background: #128C7E;
    }

    .login-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .login-error {
      color: #dc3545;
      margin-top: 10px;
      text-align: center;
      display: none;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 10px 0;
    }

    /* Panel de Administraci√≥n */
    .admin-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      padding: 20px 0;
    }

    .logo-admin {
      text-align: center;
      padding: 20px;
      border-bottom: 1px solid #34495e;
    }

    .logo-admin img {
      max-width: 150px;
    }

    .nav-admin {
      list-style: none;
      margin-top: 20px;
    }

    .nav-admin li {
      padding: 15px 25px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .nav-admin li:hover,
    .nav-admin li.active {
      background: #34495e;
      border-left: 4px solid #25D366;
    }

    .nav-admin i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    /* Contenido principal */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .header-admin {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #25D366;
    }

    .stat-label {
      color: #666;
      margin-top: 5px;
    }

    /* Tablas */
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
    }

    tr:hover {
      background: #f8f9fa;
    }

    /* Formularios */
    .form-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    textarea {
      height: 100px;
      resize: vertical;
    }

    /* Upload de im√°genes */
    .file-upload {
      border: 2px dashed #ddd;
      border-radius: 5px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .file-upload:hover {
      border-color: #25D366;
    }

    .file-upload input {
      display: none;
    }

    .file-upload-label {
      display: block;
      color: #666;
      cursor: pointer;
    }

    .file-upload-label i {
      font-size: 24px;
      margin-bottom: 10px;
      display: block;
    }

    .image-preview {
      max-width: 200px;
      max-height: 150px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
    }

    .banner-preview {
      max-width: 100%;
      max-height: 300px;
      margin: 20px 0;
      border-radius: 10px;
      display: none;
    }

    .upload-status {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }

    /* Botones */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .btn-primary {
      background: #25D366;
      color: white;
    }

    .btn-primary:hover {
      background: #128C7E;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    /* Estados */
    .estado-pendiente {
      background: #fff3cd;
      color: #856404;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
    }

    .estado-completado {
      background: #d1edff;
      color: #004085;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
    }

    /* Secciones */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Banner Oferta y Rifas */
    .banner-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .banner-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .banner-info {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .banner-actions {
        flex-direction: column;
      }

      .header-admin {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <!-- Pantalla de Login -->
  <div id="login-screen" class="login-container">
    <div class="login-box">
      <div class="login-logo">
        <h2>PuntoAlmacen</h2>
        <p>Panel de Administraci√≥n</p>
      </div>
      <form class="login-form" id="login-form">
        <div class="form-group">
          <label for="username">Usuario</label>
          <input type="text" id="username" placeholder="Ingresa tu usuario" required>
        </div>
        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <input type="password" id="password" placeholder="Ingresa tu contrase√±a" required>
        </div>
        <button type="submit" class="login-btn" id="login-btn">Iniciar Sesi√≥n</button>
        <div class="loading" id="login-loading">Verificando credenciales...</div>
        <div class="login-error" id="login-error">
          Usuario o contrase√±a incorrectos
        </div>
      </form>
    </div>
  </div>

  <!-- Panel de Administraci√≥n -->
  <div id="admin-panel" class="admin-container" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo-admin">
        <h2>PuntoAlmacen</h2>
        <p>Panel de Administraci√≥n</p>
      </div>
      
      <ul class="nav-admin">
        <li class="active" data-section="dashboard">üìä Dashboard</li>
        <li data-section="productos">üõçÔ∏è Productos</li>
        <li data-section="pedidos">üì¶ Pedidos</li>
        <li data-section="banners">üéØ Banners</li>
        <li data-section="categorias">üìÅ Categor√≠as</li>
        <li data-section="configuracion">‚öôÔ∏è Configuraci√≥n</li>
      </ul>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
      <!-- Header -->
      <div class="header-admin">
        <h1 id="section-title">Dashboard</h1>
        <div class="header-actions">
          <span id="admin-user">Administrador</span>
          <button class="btn btn-info" onclick="volverATienda()">üè† Volver a Tienda</button>
          <button class="btn btn-secondary" onclick="cerrarSesion()">üîí Cerrar Sesi√≥n</button>
        </div>
      </div>

      <!-- Secci√≥n Dashboard -->
      <div id="dashboard" class="section active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="total-ventas">$0</div>
            <div class="stat-label">Ventas Totales</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="total-pedidos">0</div>
            <div class="stat-label">Pedidos Hoy</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="total-productos">0</div>
            <div class="stat-label">Productos Activos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pedidos-pendientes">0</div>
            <div class="stat-label">Pedidos Pendientes</div>
          </div>
        </div>

        <div class="table-container">
          <h3 style="padding: 20px 20px 0;">√öltimos Pedidos</h3>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-pedidos-recientes">
              <!-- Los pedidos se cargar√°n aqu√≠ -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Productos -->
      <div id="productos" class="section">
        <div class="form-container">
          <h3>Agregar Nuevo Producto</h3>
          <form id="form-producto">
            <div class="form-group">
              <label for="producto-nombre">Nombre del Producto</label>
              <input type="text" id="producto-nombre" required>
            </div>
            
            <div class="form-group">
              <label for="producto-precio">Precio</label>
              <input type="number" id="producto-precio" step="0.01" required>
            </div>
            
            <div class="form-group">
              <label for="producto-categoria">Categor√≠a</label>
              <select id="producto-categoria" required>
                <option value="">Seleccionar categor√≠a</option>
                <option value="almacen">Almac√©n</option>
                <option value="indumentaria">Indumentaria</option>
                <option value="electro">Electro</option>
                <option value="libreria">Librer√≠a</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Imagen del Producto</label>
              <div class="file-upload" id="producto-upload">
                <input type="file" id="producto-file" accept="image/*">
                <label for="producto-file" class="file-upload-label">
                  üì∏ Hacer clic aqu√≠ para subir imagen
                  <br>
                  <small>Formatos: JPG, PNG (Recomendado: 400x400px)</small>
                </label>
              </div>
              <img id="producto-preview" class="image-preview" alt="Vista previa del producto">
              <div class="upload-status" id="producto-status"></div>
              <input type="hidden" id="producto-imagen-url">
            </div>
            
            <div class="form-group">
              <label for="producto-descripcion">Descripci√≥n</label>
              <textarea id="producto-descripcion"></textarea>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="producto-destacado"> 
                üè∑Ô∏è Producto Destacado (aparecer√° como oferta)
              </label>
            </div>
            
            <button type="submit" class="btn btn-primary">üíæ Guardar Producto</button>
            <div class="loading" id="producto-loading">Guardando producto...</div>
          </form>
        </div>

        <div class="table-container">
          <h3>Lista de Productos</h3>
          <div class="loading" id="productos-loading">Cargando productos...</div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Categor√≠a</th>
                <th>Destacado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-productos">
              <!-- Los productos se cargar√°n aqu√≠ -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Pedidos -->
      <div id="pedidos" class="section">
        <div class="table-container">
          <h3>Gesti√≥n de Pedidos</h3>
          <div class="loading" id="pedidos-loading">Cargando pedidos...</div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Productos</th>
                <th>Subtotal</th>
                <th>Env√≠o</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-pedidos">
              <!-- Los pedidos se cargar√°n aqu√≠ -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Banners -->
      <div id="banners" class="section">
        <!-- Gesti√≥n de Banner de Oferta -->
        <div class="banner-container">
          <h3>üéØ Gesti√≥n del Banner de Oferta</h3>
          <p>Sube una imagen para mostrar en el banner principal de la tienda</p>
          
          <div class="file-upload" id="banner-oferta-upload">
            <input type="file" id="banner-oferta-file" accept="image/*">
            <label for="banner-oferta-file" class="file-upload-label">
              üìÅ Hacer clic aqu√≠ para subir imagen del banner de oferta
              <br>
              <small>Formatos: JPG, PNG, GIF (Recomendado: 1200x400px)</small>
            </label>
          </div>
          
          <img id="banner-oferta-preview" class="banner-preview" alt="Vista previa del banner de oferta">
          
          <div class="upload-status" id="banner-oferta-status"></div>
          
          <div class="banner-actions">
            <button class="btn btn-primary" onclick="guardarBannerOferta()" id="btn-guardar-banner-oferta" disabled>
              üíæ Guardar Banner Oferta
            </button>
            <button class="btn btn-secondary" onclick="restaurarBannerOfertaDefault()">
              üîÑ Restaurar Banner Predeterminado
            </button>
          </div>
          
          <div class="banner-info">
            <h4>üìù Banner de Oferta Actual:</h4>
            <div id="banner-oferta-actual-info">
              <em>Cargando informaci√≥n del banner actual...</em>
            </div>
          </div>
        </div>

        <!-- Gesti√≥n de Banner de Rifas -->
        <div class="banner-container">
          <h3>üéâ Gesti√≥n del Banner de Rifas</h3>
          <p>Sube una imagen para mostrar en el banner de rifas de la tienda</p>
          
          <div class="file-upload" id="banner-rifas-upload">
            <input type="file" id="banner-rifas-file" accept="image/*">
            <label for="banner-rifas-file" class="file-upload-label">
              üìÅ Hacer clic aqu√≠ para subir imagen del banner de rifas
              <br>
              <small>Formatos: JPG, PNG, GIF (Recomendado: 1200x300px)</small>
            </label>
          </div>
          
          <img id="banner-rifas-preview" class="banner-preview" alt="Vista previa del banner de rifas">
          
          <div class="upload-status" id="banner-rifas-status"></div>
          
          <div class="banner-actions">
            <button class="btn btn-warning" onclick="guardarBannerRifas()" id="btn-guardar-banner-rifas" disabled>
              üíæ Guardar Banner Rifas
            </button>
            <button class="btn btn-secondary" onclick="restaurarBannerRifasDefault()">
              üîÑ Restaurar Banner Predeterminado
            </button>
            <button class="btn btn-danger" onclick="desactivarBannerRifas()">
              üö´ Desactivar Banner Rifas
            </button>
          </div>
          
          <div class="banner-info">
            <h4>üìù Banner de Rifas Actual:</h4>
            <div id="banner-rifas-actual-info">
              <em>Cargando informaci√≥n del banner actual...</em>
            </div>
          </div>
        </div>
      </div>

      <!-- Secci√≥n Categor√≠as -->
      <div id="categorias" class="section">
        <div class="form-container">
          <h3>Gesti√≥n de Categor√≠as</h3>
          <form id="form-categoria">
            <div class="form-group">
              <label for="categoria-nombre">Nombre de la Categor√≠a</label>
              <input type="text" id="categoria-nombre" required>
            </div>
            
            <div class="form-group">
              <label for="categoria-descripcion">Descripci√≥n</label>
              <textarea id="categoria-descripcion"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">Agregar Categor√≠a</button>
          </form>
        </div>

        <div class="table-container">
          <h3>Categor√≠as Existentes</h3>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Descripci√≥n</th>
                <th>Productos</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-categorias">
              <!-- Las categor√≠as se cargar√°n aqu√≠ -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Configuraci√≥n -->
      <div id="configuracion" class="section">
        <div class="form-container">
          <h3>Configuraci√≥n de la Tienda</h3>
          <form id="form-configuracion">
            <div class="form-group">
              <label for="config-nombre">Nombre de la Tienda</label>
              <input type="text" id="config-nombre" value="PuntoAlmacen" required>
            </div>
            
            <div class="form-group">
              <label for="config-whatsapp">N√∫mero de WhatsApp</label>
              <input type="text" id="config-whatsapp" value="5493624840349" required>
            </div>
            
            <div class="form-group">
              <label for="config-direccion">Direcci√≥n</label>
              <input type="text" id="config-direccion" value="Calle Falsa 123, Ciudad" required>
            </div>
            
            <div class="form-group">
              <label for="config-horarios">Horarios de Atenci√≥n</label>
              <input type="text" id="config-horarios" value="L a V 9-18 hs" required>
            </div>
            
            <div class="form-group">
              <label for="config-mensaje">Mensaje Autom√°tico WhatsApp</label>
              <textarea id="config-mensaje">Hola PuntoAlmacen, quiero hacer un pedido</textarea>
            </div>

            <div class="form-group">
              <label for="config-envio-gratis">M√≠nimo para env√≠o gratis</label>
              <input type="number" id="config-envio-gratis" value="10000" required>
              <small>Establece el monto m√≠nimo para que el env√≠o sea gratuito</small>
            </div>

            <div class="form-group">
              <label for="config-costo-envio">Costo normal de env√≠o</label>
              <input type="number" id="config-costo-envio" value="800" required>
              <small>Costo de env√≠o cuando no se alcanza el m√≠nimo</small>
            </div>
            
            <button type="submit" class="btn btn-primary">Guardar Configuraci√≥n</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================================
    // CONFIGURACI√ìN PARSE/BACK4APP
    // =============================================

    // Inicializar Parse con tus credenciales de Back4app [citation:1][citation:10]
    Parse.initialize("sbbQLlkupAVhCVM3ZYz29GD18w4PeZa9em3brji9", "yLu8MFWZbeBVn1tTIBIUWXECaVLG81531xWul4Tk");
    Parse.serverURL = 'https://parseapi.back4app.com/';

    // =============================================
    // SISTEMA DE AUTENTICACI√ìN
    // =============================================

    // Verificar sesi√≥n activa
    async function verificarSesion() {
      try {
        const usuarioActual = await Parse.User.currentAsync();
        if (usuarioActual) {
          // Verificar si el usuario tiene rol de administrador
          const esAdmin = usuarioActual.get('esAdmin');
          if (esAdmin) {
            mostrarPanelAdmin();
            document.getElementById('admin-user').textContent = usuarioActual.get('username');
            return true;
          } else {
            console.warn('El usuario no tiene permisos de administrador');
            await Parse.User.logOut();
          }
        }
      } catch (error) {
        console.error('Error verificando sesi√≥n:', error);
      }
      return false;
    }

    // Manejar el formulario de login
    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');
      const loginBtn = document.getElementById('login-btn');
      const loadingDiv = document.getElementById('login-loading');
      
      // Mostrar estado de carga
      loginBtn.disabled = true;
      loadingDiv.style.display = 'block';
      errorDiv.style.display = 'none';
      
      try {
        // Intentar login con Parse [citation:9]
        const user = await Parse.User.logIn(username, password);
        
        // Verificar si es administrador
        const esAdmin = user.get('esAdmin');
        if (esAdmin === true) {
          mostrarPanelAdmin();
          document.getElementById('admin-user').textContent = user.get('username');
        } else {
          await Parse.User.logOut();
          throw new Error('No tienes permisos de administrador');
        }
        
      } catch (error) {
        errorDiv.textContent = 'Credenciales incorrectas o sin permisos de administrador';
        errorDiv.style.display = 'block';
      } finally {
        loginBtn.disabled = false;
        loadingDiv.style.display = 'none';
      }
    });

    // Mostrar el panel de administraci√≥n
    function mostrarPanelAdmin() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'flex';
      cargarDashboard();
      cargarProductos();
      cargarPedidos();
      cargarCategorias();
      inicializarUploads();
      cargarInfoBannersActuales();
    }

    // Volver a la p√°gina principal de la tienda
    function volverATienda() {
      if (confirm('¬øVolver a la p√°gina principal de la tienda?')) {
        window.location.href = 'index.html';
      }
    }

    // Cerrar sesi√≥n
    async function cerrarSesion() {
      if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        try {
          await Parse.User.logOut();
          document.getElementById('admin-panel').style.display = 'none';
          document.getElementById('login-screen').style.display = 'flex';
          document.getElementById('login-form').reset();
        } catch (error) {
          console.error('Error cerrando sesi√≥n:', error);
        }
      }
    }

    // =============================================
    // MODELOS DE DATOS PARA BACK4APP
    // =============================================

    // Clase Producto
    class Producto extends Parse.Object {
      constructor() {
        super('Producto');
      }
      
      static async crear(data) {
        const producto = new Producto();
        
        // Configurar los datos del producto [citation:10]
        producto.set('nombre', data.nombre);
        producto.set('precio', data.precio);
        producto.set('categoria', data.categoria);
        producto.set('descripcion', data.descripcion || '');
        producto.set('destacado', data.destacado || false);
        producto.set('imagen', data.imagen || 'img/productos/default.jpg');
        producto.set('activo', true);
        
        // Guardar en Back4app
        try {
          const resultado = await producto.save();
          return resultado;
        } catch (error) {
          console.error('Error guardando producto:', error);
          throw error;
        }
      }
      
      static async obtenerTodos() {
        const query = new Parse.Query(Producto);
        query.equalTo('activo', true);
        query.descending('createdAt');
        try {
          return await query.find();
        } catch (error) {
          console.error('Error obteniendo productos:', error);
          return [];
        }
      }
      
      static async eliminar(id) {
        try {
          const query = new Parse.Query(Producto);
          const producto = await query.get(id);
          producto.set('activo', false);
          await producto.save();
          return true;
        } catch (error) {
          console.error('Error eliminando producto:', error);
          throw error;
        }
      }
    }

    // Clase Pedido
    class Pedido extends Parse.Object {
      constructor() {
        super('Pedido');
      }
      
      static async obtenerTodos() {
        const query = new Parse.Query(Pedido);
        query.descending('createdAt');
        try {
          return await query.find();
        } catch (error) {
          console.error('Error obteniendo pedidos:', error);
          return [];
        }
      }
      
      static async obtenerRecientes(limite = 5) {
        const query = new Parse.Query(Pedido);
        query.descending('createdAt');
        query.limit(limite);
        try {
          return await query.find();
        } catch (error) {
          console.error('Error obteniendo pedidos recientes:', error);
          return [];
        }
      }
      
      static async cambiarEstado(id, nuevoEstado) {
        try {
          const query = new Parse.Query(Pedido);
          const pedido = await query.get(id);
          pedido.set('estado', nuevoEstado);
          await pedido.save();
          return true;
        } catch (error) {
          console.error('Error cambiando estado del pedido:', error);
          throw error;
        }
      }
    }

    // Clase Categoria
    class Categoria extends Parse.Object {
      constructor() {
        super('Categoria');
      }
      
      static async obtenerTodas() {
        const query = new Parse.Query(Categoria);
        query.ascending('nombre');
        try {
          return await query.find();
        } catch (error) {
          console.error('Error obteniendo categor√≠as:', error);
          return [];
        }
      }
    }

    // =============================================
    // FUNCIONES PRINCIPALES ACTUALIZADAS
    // =============================================

    // Cargar dashboard con datos reales
    async function cargarDashboard() {
      try {
        // Obtener datos de Back4app
        const pedidosRecientes = await Pedido.obtenerRecientes(5);
        const todosLosPedidos = await Pedido.obtenerTodos();
        const productos = await Producto.obtenerTodos();
        
        // Calcular estad√≠sticas
        const totalVentas = todosLosPedidos.reduce((sum, pedido) => sum + (pedido.get('total') || 0), 0);
        const hoy = new Date().toDateString();
        const pedidosHoy = todosLosPedidos.filter(pedido => 
          new Date(pedido.createdAt).toDateString() === hoy
        ).length;
        const pedidosPendientes = todosLosPedidos.filter(pedido => 
          pedido.get('estado') === 'pendiente'
        ).length;

        // Actualizar UI
        document.getElementById('total-ventas').textContent = `$${totalVentas}`;
        document.getElementById('total-pedidos').textContent = pedidosHoy;
        document.getElementById('total-productos').textContent = productos.length;
        document.getElementById('pedidos-pendientes').textContent = pedidosPendientes;

        // Cargar pedidos recientes
        const tablaPedidos = document.getElementById('tabla-pedidos-recientes');
        tablaPedidos.innerHTML = pedidosRecientes.map(pedido => `
          <tr>
            <td>${pedido.id}</td>
            <td>${pedido.get('cliente') || 'Cliente'}</td>
            <td>$${pedido.get('total') || 0}</td>
            <td><span class="estado-${pedido.get('estado') || 'pendiente'}">${pedido.get('estado') || 'pendiente'}</span></td>
            <td>${new Date(pedido.createdAt).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="verPedido('${pedido.id}')">Ver</button>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error cargando dashboard:', error);
        alert('Error al cargar el dashboard');
      }
    }

    // Cargar productos desde Back4app
    async function cargarProductos() {
      const loadingDiv = document.getElementById('productos-loading');
      const tablaProductos = document.getElementById('tabla-productos');
      
      loadingDiv.style.display = 'block';
      tablaProductos.innerHTML = '';
      
      try {
        const productos = await Producto.obtenerTodos();
        
        tablaProductos.innerHTML = productos.map(producto => `
          <tr>
            <td>${producto.id}</td>
            <td>
              <img src="${producto.get('imagen')}" alt="${producto.get('nombre')}" 
                   style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" 
                   onerror="this.src='https://via.placeholder.com/50x50/25D366/ffffff?text=IMG'">
            </td>
            <td>${producto.get('nombre')}</td>
            <td>$${producto.get('precio')}</td>
            <td>${producto.get('categoria')}</td>
            <td>${producto.get('destacado') ? '‚≠ê' : ''}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="editarProducto('${producto.id}')">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="eliminarProducto('${producto.id}')">Eliminar</button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('Error cargando productos:', error);
        tablaProductos.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc3545;">Error al cargar los productos</td></tr>';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Formulario de producto
    document.getElementById('form-producto').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const loadingDiv = document.getElementById('producto-loading');
      const submitBtn = this.querySelector('button[type="submit"]');
      
      loadingDiv.style.display = 'block';
      submitBtn.disabled = true;
      
      try {
        const imagenUrl = document.getElementById('producto-imagen-url').value || 'img/productos/default.jpg';
        
        const datosProducto = {
          nombre: document.getElementById('producto-nombre').value,
          precio: parseFloat(document.getElementById('producto-precio').value),
          categoria: document.getElementById('producto-categoria').value,
          imagen: imagenUrl,
          descripcion: document.getElementById('producto-descripcion').value,
          destacado: document.getElementById('producto-destacado').checked
        };

        await Producto.crear(datosProducto);
        
        // Resetear formulario
        this.reset();
        document.getElementById('producto-preview').style.display = 'none';
        document.getElementById('producto-status').textContent = '';
        
        // Recargar lista
        await cargarProductos();
        await cargarDashboard();
        
        alert('‚úÖ Producto agregado correctamente');
        
      } catch (error) {
        console.error('Error guardando producto:', error);
        alert('Error al guardar el producto: ' + error.message);
      } finally {
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    // Cargar pedidos desde Back4app
    async function cargarPedidos() {
      const loadingDiv = document.getElementById('pedidos-loading');
      const tablaPedidos = document.getElementById('tabla-pedidos');
      
      loadingDiv.style.display = 'block';
      tablaPedidos.innerHTML = '';
      
      try {
        const pedidos = await Pedido.obtenerTodos();
        
        tablaPedidos.innerHTML = pedidos.map(pedido => `
          <tr>
            <td>${pedido.id}</td>
            <td>
              <strong>${pedido.get('cliente') || 'Cliente'}</strong><br>
              <small>${pedido.get('telefono') || 'Sin tel√©fono'}</small>
            </td>
            <td>
              ${Array.isArray(pedido.get('productos')) ? 
                pedido.get('productos').map(p => `${p.nombre} x${p.cantidad}`).join('<br>') : 
                'Sin productos'}
            </td>
            <td>$${pedido.get('subtotal') || 0}</td>
            <td>${pedido.get('envio') === 0 ? '<span style="color: #25D366;">GRATIS</span>' : `$${pedido.get('envio') || 0}`}</td>
            <td>$${pedido.get('total') || 0}</td>
            <td><span class="estado-${pedido.get('estado') || 'pendiente'}">${pedido.get('estado') || 'pendiente'}</span></td>
            <td>${new Date(pedido.createdAt).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="cambiarEstadoPedido('${pedido.id}', 'completado')">Completar</button>
              <button class="btn btn-sm btn-secondary" onclick="verPedido('${pedido.id}')">Detalles</button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('Error cargando pedidos:', error);
        tablaPedidos.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #dc3545;">Error al cargar los pedidos</td></tr>';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Cargar categor√≠as
    async function cargarCategorias() {
      try {
        const categorias = await Categoria.obtenerTodas();
        const tablaCategorias = document.getElementById('tabla-categorias');
        
        // Esto es un ejemplo b√°sico, puedes expandirlo seg√∫n tus necesidades
        if (categorias.length === 0) {
          tablaCategorias.innerHTML = `
            <tr>
              <td>1</td>
              <td>Almac√©n</td>
              <td>Productos de almac√©n y comida</td>
              <td>0</td>
              <td>
                <button class="btn btn-sm btn-secondary">Editar</button>
                <button class="btn btn-sm btn-danger">Eliminar</button>
              </td>
            </tr>
          `;
        }
        
      } catch (error) {
        console.error('Error cargando categor√≠as:', error);
      }
    }

    // =============================================
    // FUNCIONES AUXILIARES
    // =============================================

    async function cambiarEstadoPedido(id, nuevoEstado) {
      try {
        await Pedido.cambiarEstado(id, nuevoEstado);
        await cargarPedidos();
        await cargarDashboard();
        alert('Estado del pedido actualizado correctamente');
      } catch (error) {
        console.error('Error cambiando estado:', error);
        alert('Error al cambiar el estado del pedido');
      }
    }

    async function verPedido(id) {
      try {
        const query = new Parse.Query(Pedido);
        const pedido = await query.get(id);
        
        let mensaje = `üõçÔ∏è Detalles del Pedido #${pedido.id}\n\n`;
        mensaje += `üë§ Cliente: ${pedido.get('cliente') || 'No especificado'}\n`;
        mensaje += `üìû Tel√©fono: ${pedido.get('telefono') || 'No especificado'}\n\n`;
        mensaje += `üì¶ Productos:\n`;
        
        if (Array.isArray(pedido.get('productos'))) {
          pedido.get('productos').forEach(p => {
            mensaje += `   ‚Ä¢ ${p.nombre} x${p.cantidad} - $${p.precio * p.cantidad}\n`;
          });
        }
        
        mensaje += `\nüí∞ Subtotal: $${pedido.get('subtotal') || 0}\n`;
        mensaje += `üöö Env√≠o: ${pedido.get('envio') === 0 ? 'GRATIS' : `$${pedido.get('envio')}`}\n`;
        mensaje += `üíµ Total: $${pedido.get('total') || 0}\n\n`;
        mensaje += `üìÖ Fecha: ${new Date(pedido.createdAt).toLocaleString()}\n`;
        mensaje += `üìã Estado: ${pedido.get('estado') || 'pendiente'}`;
        
        alert(mensaje);
      } catch (error) {
        console.error('Error viendo pedido:', error);
        alert('Error al cargar los detalles del pedido');
      }
    }

    async function eliminarProducto(id) {
      if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
        try {
          await Producto.eliminar(id);
          await cargarProductos();
          await cargarDashboard();
          alert('Producto eliminado correctamente');
        } catch (error) {
          console.error('Error eliminando producto:', error);
          alert('Error al eliminar el producto');
        }
      }
    }

    async function editarProducto(id) {
      // Implementaci√≥n b√°sica - puedes expandir esto
      alert('Funcionalidad de edici√≥n en desarrollo. Por ahora, elimina y crea un nuevo producto.');
    }

    // =============================================
    // SISTEMA DE UPLOAD DE ARCHIVOS [citation:6]
    // =============================================

    let bannerOfertaFile = null;
    let bannerRifasFile = null;
    let productoFile = null;

    function inicializarUploads() {
      // Upload de banner oferta
      document.getElementById('banner-oferta-file').addEventListener('change', function(e) {
        bannerOfertaFile = e.target.files[0];
        if (bannerOfertaFile) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('banner-oferta-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('btn-guardar-banner-oferta').disabled = false;
            document.getElementById('banner-oferta-status').textContent = `‚úÖ Imagen cargada: ${bannerOfertaFile.name} (${Math.round(bannerOfertaFile.size/1024)} KB)`;
          };
          reader.readAsDataURL(bannerOfertaFile);
        }
      });

      // Upload de banner rifas
      document.getElementById('banner-rifas-file').addEventListener('change', function(e) {
        bannerRifasFile = e.target.files[0];
        if (bannerRifasFile) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('banner-rifas-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('btn-guardar-banner-rifas').disabled = false;
            document.getElementById('banner-rifas-status').textContent = `‚úÖ Imagen cargada: ${bannerRifasFile.name} (${Math.round(bannerRifasFile.size/1024)} KB)`;
          };
          reader.readAsDataURL(bannerRifasFile);
        }
      });

      // Upload de producto
      document.getElementById('producto-file').addEventListener('change', function(e) {
        productoFile = e.target.files[0];
        if (productoFile) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('producto-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('producto-status').textContent = `‚úÖ Imagen cargada: ${productoFile.name}`;
            document.getElementById('producto-imagen-url').value = e.target.result;
          };
          reader.readAsDataURL(productoFile);
        }
      });
    }

    // Funciones de banners (mantenidas de tu c√≥digo original)
    function guardarBannerOferta() {
      if (!bannerOfertaFile) {
        alert('Por favor, selecciona una imagen primero');
        return;
      }
      // Implementaci√≥n para guardar en Back4app ir√≠a aqu√≠
      alert('Funcionalidad de banner en desarrollo');
    }

    function restaurarBannerOfertaDefault() {
      // Implementaci√≥n para Back4app
      alert('Funcionalidad de banner en desarrollo');
    }

    function guardarBannerRifas() {
      if (!bannerRifasFile) {
        alert('Por favor, selecciona una imagen primero');
        return;
      }
      // Implementaci√≥n para guardar en Back4app ir√≠a aqu√≠
      alert('Funcionalidad de banner en desarrollo');
    }

    function restaurarBannerRifasDefault() {
      // Implementaci√≥n para Back4app
      alert('Funcionalidad de banner en desarrollo');
    }

    function desactivarBannerRifas() {
      if (confirm('¬øEst√°s seguro de que quieres desactivar el banner de rifas?')) {
        // Implementaci√≥n para Back4app
        alert('Banner de rifas desactivado (funcionalidad en desarrollo)');
      }
    }

    function cargarInfoBannersActuales() {
      // Informaci√≥n b√°sica - puedes expandir esto para Back4app
      document.getElementById('banner-oferta-actual-info').innerHTML = `
        <strong>Banner Predeterminado</strong><br>
        üñºÔ∏è Usando configuraci√≥n por defecto<br>
        ‚úÖ <strong>Activo en la tienda</strong>
      `;
      
      document.getElementById('banner-rifas-actual-info').innerHTML = `
        <strong>Banner No Configurado</strong><br>
        üö´ No hay banner de rifas activo<br>
        ‚ö†Ô∏è <strong>No se mostrar√° en la tienda</strong>
      `;
    }

    // =============================================
    // NAVEGACI√ìN Y CONFIGURACI√ìN
    // =============================================
    
    // Navegaci√≥n entre secciones
    document.querySelectorAll('.nav-admin li').forEach(item => {
      item.addEventListener('click', function() {
        // Remover clase active de todos
        document.querySelectorAll('.nav-admin li').forEach(li => li.classList.remove('active'));
        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        
        // Agregar clase active al seleccionado
        this.classList.add('active');
        const sectionId = this.getAttribute('data-section');
        document.getElementById(sectionId).classList.add('active');
        document.getElementById('section-title').textContent = this.textContent.trim();
      });
    });

    // Configuraci√≥n
    document.getElementById('form-configuracion').addEventListener('submit', function(e) {
      e.preventDefault();
      // Aqu√≠ puedes implementar el guardado en Back4app
      alert('Configuraci√≥n guardada correctamente (funcionalidad en desarrollo para Back4app)');
    });

    // =============================================
    // INICIALIZACI√ìN
    // =============================================
    
    // Verificar sesi√≥n al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      verificarSesion();
    });

  </script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel de Administraci√≥n - PuntoAlmacen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Incluir SDK de Parse -->
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <style>
    /* Estilos generales */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    /* Pantalla de Login */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #25D366, #128C7E);
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-logo h2 {
      color: #25D366;
      margin-bottom: 5px;
    }

    .login-form .form-group {
      margin-bottom: 20px;
    }

    .login-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .login-form input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      background: #25D366;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-btn:hover {
      background: #128C7E;
    }

    .login-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .login-error {
      color: #dc3545;
      margin-top: 10px;
      text-align: center;
      display: none;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 10px 0;
    }

    /* Panel de Administraci√≥n */
    .admin-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      padding: 20px 0;
    }

    .logo-admin {
      text-align: center;
      padding: 20px;
      border-bottom: 1px solid #34495e;
    }

    .logo-admin img {
      max-width: 150px;
    }

    .nav-admin {
      list-style: none;
      margin-top: 20px;
    }

    .nav-admin li {
      padding: 15px 25px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .nav-admin li:hover,
    .nav-admin li.active {
      background: #34495e;
      border-left: 4px solid #25D366;
    }

    .nav-admin i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    /* Contenido principal */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .header-admin {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #25D366;
    }

    .stat-label {
      color: #666;
      margin-top: 5px;
    }

    /* Tablas */
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
    }

    tr:hover {
      background: #f8f9fa;
    }

    /* Formularios */
    .form-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    textarea {
      height: 100px;
      resize: vertical;
    }

    /* Upload de im√°genes */
    .file-upload {
      border: 2px dashed #ddd;
      border-radius: 5px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .file-upload:hover {
      border-color: #25D366;
    }

    .file-upload input {
      display: none;
    }

    .file-upload-label {
      display: block;
      color: #666;
      cursor: pointer;
    }

    .file-upload-label i {
      font-size: 24px;
      margin-bottom: 10px;
      display: block;
    }

    .image-preview {
      max-width: 200px;
      max-height: 150px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
    }

    .banner-preview {
      max-width: 100%;
      max-height: 300px;
      margin: 20px 0;
      border-radius: 10px;
      display: none;
    }

    .upload-status {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }

    /* Botones */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .btn-primary {
      background: #25D366;
      color: white;
    }

    .btn-primary:hover {
      background: #128C7E;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    /* Estados */
    .estado-pendiente {
      background: #fff3cd;
      color: #856404;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
    }

    .estado-completado {
      background: #d1edff;
      color: #004085;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
    }

    /* Secciones */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Banner Oferta y Rifas */
    .banner-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .banner-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .banner-info {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    /* Notificaciones */
    .notificacion {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #25D366;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      z-index: 1000;
      animation: fadeInOut 3s ease-in-out;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .notificacion.error {
      background: #dc3545;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-20px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .banner-actions {
        flex-direction: column;
      }

      .header-admin {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <!-- Pantalla de Login -->
  <div id="login-screen" class="login-container">
    <div class="login-box">
      <div class="login-logo">
        <h2>PuntoAlmacen</h2>
        <p>Panel de Administraci√≥n</p>
      </div>
      <form class="login-form" id="login-form">
        <div class="form-group">
          <label for="username">Usuario</label>
          <input type="text" id="username" placeholder="Ingresa tu usuario" required>
        </div>
        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <input type="password" id="password" placeholder="Ingresa tu contrase√±a" required>
        </div>
        <button type="submit" class="login-btn" id="login-btn">Iniciar Sesi√≥n</button>
        <div class="loading" id="login-loading">Verificando credenciales...</div>
        <div class="login-error" id="login-error">
          Usuario o contrase√±a incorrectos
        </div>
      </form>
    </div>
  </div>

  <!-- Panel de Administraci√≥n -->
  <div id="admin-panel" class="admin-container" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo-admin">
        <h2>PuntoAlmacen</h2>
        <p>Panel de Administraci√≥n</p>
      </div>
      
      <ul class="nav-admin">
        <li class="active" data-section="dashboard">üìä Dashboard</li>
        <li data-section="productos">üõçÔ∏è Productos</li>
        <li data-section="pedidos">üì¶ Pedidos</li>
        <li data-section="banners">üéØ Banners</li>
        <li data-section="configuracion">‚öôÔ∏è Configuraci√≥n</li>
      </ul>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
      <!-- Header -->
      <div class="header-admin">
        <h1 id="section-title">Dashboard</h1>
        <div class="header-actions">
          <span id="admin-user">Administrador</span>
          <button class="btn btn-info" onclick="volverATienda()">üè† Volver a Tienda</button>
          <button class="btn btn-secondary" onclick="cerrarSesion()">üîí Cerrar Sesi√≥n</button>
        </div>
      </div>

      <!-- Secci√≥n Dashboard -->
      <div id="dashboard" class="section active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="total-ventas">$0</div>
            <div class="stat-label">Ventas Totales</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="total-pedidos">0</div>
            <div class="stat-label">Pedidos Hoy</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="total-productos">0</div>
            <div class="stat-label">Productos Activos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pedidos-pendientes">0</div>
            <div class="stat-label">Pedidos Pendientes</div>
          </div>
        </div>

        <div class="table-container">
          <h3 style="padding: 20px 20px 0;">√öltimos Pedidos</h3>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-pedidos-recientes">
              <tr><td colspan="6" style="text-align: center;">Cargando pedidos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Productos -->
      <div id="productos" class="section">
        <div class="form-container">
          <h3>Agregar Nuevo Producto</h3>
          <form id="form-producto">
            <div class="form-group">
              <label for="producto-nombre">Nombre del Producto</label>
              <input type="text" id="producto-nombre" required>
            </div>
            
            <div class="form-group">
              <label for="producto-precio">Precio</label>
              <input type="number" id="producto-precio" step="0.01" required>
            </div>
            
            <div class="form-group">
              <label for="producto-categoria">Categor√≠a</label>
              <select id="producto-categoria" required>
                <option value="">Seleccionar categor√≠a</option>
                <option value="almacen">Almac√©n</option>
                <option value="indumentaria">Indumentaria</option>
                <option value="electro">Electro</option>
                <option value="libreria">Librer√≠a</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Imagen del Producto</label>
              <div class="file-upload" id="producto-upload">
                <input type="file" id="producto-file" accept="image/*">
                <label for="producto-file" class="file-upload-label">
                  üì∏ Hacer clic aqu√≠ para subir imagen
                  <br>
                  <small>Formatos: JPG, PNG (Recomendado: 400x400px)</small>
                </label>
              </div>
              <img id="producto-preview" class="image-preview" alt="Vista previa del producto">
              <div class="upload-status" id="producto-status"></div>
              <input type="hidden" id="producto-imagen-url">
            </div>
            
            <div class="form-group">
              <label for="producto-descripcion">Descripci√≥n</label>
              <textarea id="producto-descripcion"></textarea>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="producto-destacado"> 
                üè∑Ô∏è Producto Destacado (aparecer√° como oferta)
              </label>
            </div>
            
            <button type="submit" class="btn btn-primary">üíæ Guardar Producto</button>
            <div class="loading" id="producto-loading">Guardando producto...</div>
          </form>
        </div>

        <div class="table-container">
          <h3>Lista de Productos</h3>
          <div class="loading" id="productos-loading">Cargando productos...</div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Categor√≠a</th>
                <th>Destacado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-productos">
              <tr><td colspan="7" style="text-align: center;">Cargando productos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Pedidos -->
      <div id="pedidos" class="section">
        <div class="table-container">
          <h3>Gesti√≥n de Pedidos</h3>
          <div class="loading" id="pedidos-loading">Cargando pedidos...</div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Productos</th>
                <th>Subtotal</th>
                <th>Env√≠o</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-pedidos">
              <tr><td colspan="9" style="text-align: center;">Cargando pedidos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Banners - COMPLETAMENTE CORREGIDA -->
      <div id="banners" class="section">
        <!-- Gesti√≥n de Banner de Oferta -->
        <div class="banner-container">
          <h3>üéØ Gesti√≥n del Banner de Oferta</h3>
          <p>Configura el banner principal de ofertas que aparece en la tienda</p>
          
          <form id="form-banner-oferta">
            <div class="form-group">
              <label for="banner-oferta-titulo">T√≠tulo del Banner</label>
              <input type="text" id="banner-oferta-titulo" placeholder="Ej: ¬°Oferta Especial! Hasta 50% OFF">
            </div>
            
            <div class="form-group">
              <label for="banner-oferta-descripcion">Descripci√≥n</label>
              <input type="text" id="banner-oferta-descripcion" placeholder="Ej: Descuentos incre√≠bles esta semana">
            </div>
            
            <div class="form-group">
              <label for="banner-oferta-enlace">Enlace WhatsApp</label>
              <input type="text" id="banner-oferta-enlace" placeholder="https://wa.me/5493624840349?text=Quiero%20la%20oferta%20del%20d√≠a">
            </div>
            
            <div class="form-group">
              <label>Imagen del Banner</label>
              <div class="file-upload" id="banner-oferta-upload">
                <input type="file" id="banner-oferta-file" accept="image/*">
                <label for="banner-oferta-file" class="file-upload-label">
                  üìÅ Hacer clic aqu√≠ para subir imagen del banner de oferta
                  <br>
                  <small>Formatos: JPG, PNG, GIF (Recomendado: 1200x400px)</small>
                </label>
              </div>
              <img id="banner-oferta-preview" class="banner-preview" alt="Vista previa del banner de oferta">
              <div class="upload-status" id="banner-oferta-status"></div>
              <input type="hidden" id="banner-oferta-imagen-url">
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="banner-oferta-activo"> 
                ‚úÖ Banner activo (se mostrar√° en la tienda)
              </label>
            </div>
            
            <div class="banner-actions">
              <button type="submit" class="btn btn-primary" id="btn-guardar-banner-oferta">
                üíæ Guardar Banner Oferta
              </button>
              <button type="button" class="btn btn-secondary" onclick="restaurarBannerOfertaDefault()">
                üîÑ Restaurar Valores Predeterminados
              </button>
            </div>
          </form>
          
          <div class="banner-info">
            <h4>üìù Informaci√≥n del Banner Actual:</h4>
            <div id="banner-oferta-actual-info">
              <em>Cargando informaci√≥n del banner actual...</em>
            </div>
          </div>
        </div>

        <!-- Gesti√≥n de Banner de Rifas -->
        <div class="banner-container">
          <h3>üéâ Gesti√≥n del Banner de Rifas</h3>
          <p>Configura el banner de rifas online que aparece en la tienda</p>
          
          <form id="form-banner-rifas">
            <div class="form-group">
              <label for="banner-rifas-titulo">T√≠tulo del Banner</label>
              <input type="text" id="banner-rifas-titulo" placeholder="Ej: ¬°Participa en Nuestras Rifas!">
            </div>
            
            <div class="form-group">
              <label for="banner-rifas-descripcion">Descripci√≥n</label>
              <input type="text" id="banner-rifas-descripcion" placeholder="Ej: Gana premios incre√≠bles">
            </div>
            
            <div class="form-group">
              <label for="banner-rifas-enlace">Enlace de Rifas</label>
              <input type="text" id="banner-rifas-enlace" placeholder="https://rifasapponline.netlify.app/">
            </div>
            
            <div class="form-group">
              <label>Imagen del Banner</label>
              <div class="file-upload" id="banner-rifas-upload">
                <input type="file" id="banner-rifas-file" accept="image/*">
                <label for="banner-rifas-file" class="file-upload-label">
                  üìÅ Hacer clic aqu√≠ para subir imagen del banner de rifas
                  <br>
                  <small>Formatos: JPG, PNG, GIF (Recomendado: 1200x300px)</small>
                </label>
              </div>
              <img id="banner-rifas-preview" class="banner-preview" alt="Vista previa del banner de rifas">
              <div class="upload-status" id="banner-rifas-status"></div>
              <input type="hidden" id="banner-rifas-imagen-url">
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="banner-rifas-activo"> 
                ‚úÖ Banner activo (se mostrar√° en la tienda)
              </label>
            </div>
            
            <div class="banner-actions">
              <button type="submit" class="btn btn-warning" id="btn-guardar-banner-rifas">
                üíæ Guardar Banner Rifas
              </button>
              <button type="button" class="btn btn-secondary" onclick="restaurarBannerRifasDefault()">
                üîÑ Restaurar Valores Predeterminados
              </button>
              <button type="button" class="btn btn-danger" onclick="desactivarBannerRifas()">
                üö´ Desactivar Banner Rifas
              </button>
            </div>
          </form>
          
          <div class="banner-info">
            <h4>üìù Informaci√≥n del Banner Actual:</h4>
            <div id="banner-rifas-actual-info">
              <em>Cargando informaci√≥n del banner actual...</em>
            </div>
          </div>
        </div>
      </div>

      <!-- Secci√≥n Configuraci√≥n -->
      <div id="configuracion" class="section">
        <div class="form-container">
          <h3>Configuraci√≥n de la Tienda</h3>
          <form id="form-configuracion">
            <div class="form-group">
              <label for="config-nombre">Nombre de la Tienda</label>
              <input type="text" id="config-nombre" value="PuntoAlmacen" required>
            </div>
            
            <div class="form-group">
              <label for="config-whatsapp">N√∫mero de WhatsApp</label>
              <input type="text" id="config-whatsapp" value="5493624840349" required>
            </div>
            
            <div class="form-group">
              <label for="config-direccion">Direcci√≥n</label>
              <input type="text" id="config-direccion" value="Calle Falsa 123, Ciudad" required>
            </div>
            
            <div class="form-group">
              <label for="config-horarios">Horarios de Atenci√≥n</label>
              <input type="text" id="config-horarios" value="L a V 9-18 hs" required>
            </div>
            
            <div class="form-group">
              <label for="config-mensaje">Mensaje Autom√°tico WhatsApp</label>
              <textarea id="config-mensaje">Hola PuntoAlmacen, quiero hacer un pedido</textarea>
            </div>

            <div class="form-group">
              <label for="config-envio-gratis">M√≠nimo para env√≠o gratis</label>
              <input type="number" id="config-envio-gratis" value="10000" required>
              <small>Establece el monto m√≠nimo para que el env√≠o sea gratuito</small>
            </div>

            <div class="form-group">
              <label for="config-costo-envio">Costo normal de env√≠o</label>
              <input type="number" id="config-costo-envio" value="800" required>
              <small>Costo de env√≠o cuando no se alcanza el m√≠nimo</small>
            </div>
            
            <button type="submit" class="btn btn-primary">üíæ Guardar Configuraci√≥n</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================================
    // CONFIGURACI√ìN PARSE/BACK4APP
    // =============================================

    // Inicializar Parse con tus credenciales de Back4app
    Parse.initialize("sbbQLlkupAVhCVM3ZYz29GD18w4PeZa9em3brji9", "yLu8MFWZbeBVn1tTIBIUWXECaVLG81531xWul4Tk");
    Parse.serverURL = 'https://parseapi.back4app.com/';

    // =============================================
    // MODELOS DE DATOS PARA BACK4APP
    // =============================================

    // Clase Banner para Back4app - MEJORADA
    class Banner extends Parse.Object {
      constructor() {
        super('Banner');
      }
      
      static async obtenerBannerPorTipo(tipo) {
        const query = new Parse.Query(Banner);
        query.equalTo('tipo', tipo);
        try {
          const banners = await query.find();
          console.log(`üîç Banners encontrados para ${tipo}:`, banners.length);
          return banners.length > 0 ? banners[0] : null;
        } catch (error) {
          console.error(`‚ùå Error obteniendo banner ${tipo}:`, error);
          return null;
        }
      }
      
      static async crearOActualizar(data) {
        try {
          // Buscar si ya existe un banner de este tipo
          let banner = await Banner.obtenerBannerPorTipo(data.tipo);
          
          if (!banner) {
            console.log(`üÜï Creando nuevo banner para tipo: ${data.tipo}`);
            banner = new Banner();
          } else {
            console.log(`üìù Actualizando banner existente para tipo: ${data.tipo}`);
          }
          
          // Configurar los datos del banner con valores por defecto
          banner.set('tipo', data.tipo);
          banner.set('titulo', data.titulo || '');
          banner.set('descripcion', data.descripcion || '');
          banner.set('enlace', data.enlace || '');
          banner.set('imagen', data.imagen || '');
          banner.set('activo', data.activo !== undefined ? data.activo : true);
          banner.set('orden', data.orden || 1);
          
          console.log('üíæ Guardando banner en Back4app...');
          const resultado = await banner.save();
          console.log('‚úÖ Banner guardado exitosamente:', resultado);
          
          return resultado;
          
        } catch (error) {
          console.error('‚ùå Error guardando banner:', error);
          throw error;
        }
      }
    }

    // Clase Configuracion para Back4app
    class Configuracion extends Parse.Object {
      constructor() {
        super('Configuracion');
      }
      
      static async obtener() {
        const query = new Parse.Query(Configuracion);
        try {
          const configs = await query.find();
          return configs.length > 0 ? configs[0] : null;
        } catch (error) {
          console.error('Error obteniendo configuraci√≥n:', error);
          return null;
        }
      }
      
      static async crearOActualizar(data) {
        try {
          let config = await Configuracion.obtener();
          
          if (!config) {
            config = new Configuracion();
          }
          
          config.set('nombreTienda', data.nombreTienda);
          config.set('whatsapp', data.whatsapp);
          config.set('direccion', data.direccion);
          config.set('horarios', data.horarios);
          config.set('mensajeWhatsApp', data.mensajeWhatsApp);
          config.set('minimoEnvioGratis', data.minimoEnvioGratis);
          config.set('costoEnvio', data.costoEnvio);
          
          const resultado = await config.save();
          return resultado;
          
        } catch (error) {
          console.error('Error guardando configuraci√≥n:', error);
          throw error;
        }
      }
    }

    // Clase Producto
    class Producto extends Parse.Object {
      constructor() {
        super('Producto');
      }
      
      static async crear(data) {
        const producto = new Producto();
        producto.set('nombre', data.nombre);
        producto.set('precio', parseFloat(data.precio));
        producto.set('categoria', data.categoria);
        producto.set('descripcion', data.descripcion || '');
        producto.set('destacado', data.destacado || false);
        producto.set('imagen', data.imagen || 'https://via.placeholder.com/300x250/25D366/ffffff?text=Producto');
        producto.set('activo', true);
        
        try {
          const resultado = await producto.save();
          return resultado;
        } catch (error) {
          console.error('Error guardando producto:', error);
          throw error;
        }
      }
      
      static async obtenerTodos() {
        const query = new Parse.Query(Producto);
        query.equalTo('activo', true);
        query.descending('createdAt');
        try {
          return await query.find();
        } catch (error) {
          console.error('Error obteniendo productos:', error);
          return [];
        }
      }
      
      static async eliminar(id) {
        try {
          const query = new Parse.Query(Producto);
          const producto = await query.get(id);
          producto.set('activo', false);
          await producto.save();
          return true;
        } catch (error) {
          console.error('Error eliminando producto:', error);
          throw error;
        }
      }
    }

    // Clase Pedido
    class Pedido extends Parse.Object {
      constructor() {
        super('Pedido');
      }
      
      static async obtenerTodos() {
        const query = new Parse.Query(Pedido);
        query.descending('createdAt');
        try {
          return await query.find();
        } catch (error) {
          console.error('Error obteniendo pedidos:', error);
          return [];
        }
      }
      
      static async obtenerRecientes(limite = 5) {
        const query = new Parse.Query(Pedido);
        query.descending('createdAt');
        query.limit(limite);
        try {
          return await query.find();
        } catch (error) {
          console.error('Error obteniendo pedidos recientes:', error);
          return [];
        }
      }
    }

    // =============================================
    // SISTEMA DE AUTENTICACI√ìN
    // =============================================

    // Verificar sesi√≥n activa
    async function verificarSesion() {
      try {
        const usuarioActual = await Parse.User.currentAsync();
        if (usuarioActual) {
          // Verificar si el usuario tiene rol de administrador
          const esAdmin = usuarioActual.get('esAdmin');
          if (esAdmin) {
            mostrarPanelAdmin();
            document.getElementById('admin-user').textContent = usuarioActual.get('username');
            return true;
          } else {
            console.warn('El usuario no tiene permisos de administrador');
            await Parse.User.logOut();
          }
        }
      } catch (error) {
        console.error('Error verificando sesi√≥n:', error);
      }
      return false;
    }

    // Manejar el formulario de login
    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');
      const loginBtn = document.getElementById('login-btn');
      const loadingDiv = document.getElementById('login-loading');
      
      // Mostrar estado de carga
      loginBtn.disabled = true;
      loadingDiv.style.display = 'block';
      errorDiv.style.display = 'none';
      
      try {
        // Intentar login con Parse
        const user = await Parse.User.logIn(username, password);
        
        // Verificar si es administrador
        const esAdmin = user.get('esAdmin');
        if (esAdmin === true) {
          mostrarPanelAdmin();
          document.getElementById('admin-user').textContent = user.get('username');
        } else {
          await Parse.User.logOut();
          throw new Error('No tienes permisos de administrador');
        }
        
      } catch (error) {
        errorDiv.textContent = 'Credenciales incorrectas o sin permisos de administrador';
        errorDiv.style.display = 'block';
      } finally {
        loginBtn.disabled = false;
        loadingDiv.style.display = 'none';
      }
    });

    // Mostrar el panel de administraci√≥n
    function mostrarPanelAdmin() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'flex';
      cargarDashboard();
      cargarProductos();
      cargarPedidos();
      inicializarUploads();
      cargarBannersActuales();
      cargarConfiguracionActual();
    }

    // Volver a la p√°gina principal de la tienda
    function volverATienda() {
      if (confirm('¬øVolver a la p√°gina principal de la tienda?')) {
        window.location.href = 'index.html';
      }
    }

    // Cerrar sesi√≥n
    async function cerrarSesion() {
      if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        try {
          await Parse.User.logOut();
          document.getElementById('admin-panel').style.display = 'none';
          document.getElementById('login-screen').style.display = 'flex';
          document.getElementById('login-form').reset();
        } catch (error) {
          console.error('Error cerrando sesi√≥n:', error);
        }
      }
    }

    // =============================================
    // SISTEMA DE GESTI√ìN DE BANNERS - COMPLETAMENTE CORREGIDO
    // =============================================

    let bannerOfertaFile = null;
    let bannerRifasFile = null;

    // Cargar informaci√≥n de banners actuales - CORREGIDO
    async function cargarBannersActuales() {
      try {
        console.log('üîÑ Cargando banners desde Back4app...');
        
        // Cargar banner de oferta
        const bannerOferta = await Banner.obtenerBannerPorTipo('oferta');
        if (bannerOferta) {
          console.log('‚úÖ Banner oferta encontrado:', bannerOferta);
          document.getElementById('banner-oferta-titulo').value = bannerOferta.get('titulo') || 'Oferta Especial';
          document.getElementById('banner-oferta-descripcion').value = bannerOferta.get('descripcion') || 'Descuentos hasta 50%';
          document.getElementById('banner-oferta-enlace').value = bannerOferta.get('enlace') || 'https://wa.me/5493624840349?text=Quiero%20la%20oferta%20del%20d√≠a';
          document.getElementById('banner-oferta-activo').checked = bannerOferta.get('activo') !== false;
          
          const imagenUrl = bannerOferta.get('imagen');
          if (imagenUrl) {
            document.getElementById('banner-oferta-imagen-url').value = imagenUrl;
            document.getElementById('banner-oferta-preview').src = imagenUrl;
            document.getElementById('banner-oferta-preview').style.display = 'block';
          }
          
          actualizarInfoBannerOferta(bannerOferta);
        } else {
          console.log('‚ÑπÔ∏è No hay banner de oferta, usando valores por defecto');
          // Establecer valores por defecto si no existe el banner
          actualizarInfoBannerOferta(null);
        }
        
        // Cargar banner de rifas
        const bannerRifas = await Banner.obtenerBannerPorTipo('rifas');
        if (bannerRifas) {
          console.log('‚úÖ Banner rifas encontrado:', bannerRifas);
          document.getElementById('banner-rifas-titulo').value = bannerRifas.get('titulo') || 'üéâ ¬°Participa en Nuestras Rifas! üéâ';
          document.getElementById('banner-rifas-descripcion').value = bannerRifas.get('descripcion') || 'Gana premios incre√≠bles - ¬°Es muy f√°cil participar!';
          document.getElementById('banner-rifas-enlace').value = bannerRifas.get('enlace') || 'https://rifasapponline.netlify.app/';
          document.getElementById('banner-rifas-activo').checked = bannerRifas.get('activo') !== false;
          
          const imagenUrl = bannerRifas.get('imagen');
          if (imagenUrl) {
            document.getElementById('banner-rifas-imagen-url').value = imagenUrl;
            document.getElementById('banner-rifas-preview').src = imagenUrl;
            document.getElementById('banner-rifas-preview').style.display = 'block';
          }
          
          actualizarInfoBannerRifas(bannerRifas);
        } else {
          console.log('‚ÑπÔ∏è No hay banner de rifas, usando valores por defecto');
          // Establecer valores por defecto si no existe el banner
          actualizarInfoBannerRifas(null);
        }
        
      } catch (error) {
        console.error('‚ùå Error cargando banners actuales:', error);
        // En caso de error, mostrar informaci√≥n por defecto
        actualizarInfoBannerOferta(null);
        actualizarInfoBannerRifas(null);
      }
    }

    // Actualizar informaci√≥n del banner de oferta - CORREGIDO
    function actualizarInfoBannerOferta(banner) {
      const infoDiv = document.getElementById('banner-oferta-actual-info');
      
      if (!banner) {
        infoDiv.innerHTML = `
          <strong>üîÑ Banner No Configurado</strong><br>
          üìù <em>Usando valores por defecto</em><br>
          üîó Enlace: No configurado<br>
          üñºÔ∏è Imagen: No configurada<br>
          ‚ùå <strong>INACTIVO - No se muestra en la tienda</strong>
        `;
        return;
      }
      
      const titulo = banner.get('titulo') || 'Sin t√≠tulo';
      const descripcion = banner.get('descripcion') || 'Sin descripci√≥n';
      const enlace = banner.get('enlace') || 'No configurado';
      const imagen = banner.get('imagen');
      const activo = banner.get('activo') !== false;
      
      infoDiv.innerHTML = `
        <strong>${titulo}</strong><br>
        üìù ${descripcion}<br>
        üîó Enlace: ${enlace}<br>
        üñºÔ∏è Imagen: ${imagen ? '‚úÖ Configurada' : '‚ùå No configurada'}<br>
        ${activo ? '‚úÖ <strong>ACTIVO en la tienda</strong>' : '‚ùå <strong>INACTIVO - No se muestra</strong>'}
      `;
    }

    // Actualizar informaci√≥n del banner de rifas - CORREGIDO
    function actualizarInfoBannerRifas(banner) {
      const infoDiv = document.getElementById('banner-rifas-actual-info');
      
      if (!banner) {
        infoDiv.innerHTML = `
          <strong>üîÑ Banner No Configurado</strong><br>
          üìù <em>Usando valores por defecto</em><br>
          üîó Enlace: No configurado<br>
          üñºÔ∏è Imagen: No configurada<br>
          ‚ùå <strong>INACTIVO - No se muestra en la tienda</strong>
        `;
        return;
      }
      
      const titulo = banner.get('titulo') || 'Sin t√≠tulo';
      const descripcion = banner.get('descripcion') || 'Sin descripci√≥n';
      const enlace = banner.get('enlace') || 'No configurado';
      const imagen = banner.get('imagen');
      const activo = banner.get('activo') !== false;
      
      infoDiv.innerHTML = `
        <strong>${titulo}</strong><br>
        üìù ${descripcion}<br>
        üîó Enlace: ${enlace}<br>
        üñºÔ∏è Imagen: ${imagen ? '‚úÖ Configurada' : '‚ùå No configurada'}<br>
        ${activo ? '‚úÖ <strong>ACTIVO en la tienda</strong>' : '‚ùå <strong>INACTIVO - No se muestra</strong>'}
      `;
    }

    // Formulario de banner de oferta - CORREGIDO
    document.getElementById('form-banner-oferta').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btnGuardar = document.getElementById('btn-guardar-banner-oferta');
      const estadoOriginal = btnGuardar.innerHTML;
      
      btnGuardar.innerHTML = 'üíæ Guardando...';
      btnGuardar.disabled = true;
      
      try {
        const titulo = document.getElementById('banner-oferta-titulo').value || 'Oferta Especial';
        const descripcion = document.getElementById('banner-oferta-descripcion').value || 'Descuentos hasta 50%';
        const enlace = document.getElementById('banner-oferta-enlace').value || 'https://wa.me/5493624840349?text=Quiero%20la%20oferta%20del%20d√≠a';
        const imagenUrl = document.getElementById('banner-oferta-imagen-url').value || 'img/banner-oferta.jpg';
        const activo = document.getElementById('banner-oferta-activo').checked;
        
        const datosBanner = {
          tipo: 'oferta',
          titulo: titulo,
          descripcion: descripcion,
          enlace: enlace,
          imagen: imagenUrl,
          activo: activo,
          orden: 1
        };

        console.log('üì§ Guardando banner oferta:', datosBanner);
        const bannerGuardado = await Banner.crearOActualizar(datosBanner);
        
        actualizarInfoBannerOferta(bannerGuardado);
        mostrarNotificacion('‚úÖ Banner de oferta guardado correctamente');
        
      } catch (error) {
        console.error('‚ùå Error guardando banner de oferta:', error);
        mostrarNotificacion('‚ùå Error al guardar el banner de oferta: ' + error.message, 'error');
      } finally {
        btnGuardar.innerHTML = estadoOriginal;
        btnGuardar.disabled = false;
      }
    });

    // Formulario de banner de rifas - CORREGIDO
    document.getElementById('form-banner-rifas').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btnGuardar = document.getElementById('btn-guardar-banner-rifas');
      const estadoOriginal = btnGuardar.innerHTML;
      
      btnGuardar.innerHTML = 'üíæ Guardando...';
      btnGuardar.disabled = true;
      
      try {
        const titulo = document.getElementById('banner-rifas-titulo').value || 'üéâ ¬°Participa en Nuestras Rifas! üéâ';
        const descripcion = document.getElementById('banner-rifas-descripcion').value || 'Gana premios incre√≠bles - ¬°Es muy f√°cil participar!';
        const enlace = document.getElementById('banner-rifas-enlace').value || 'https://rifasapponline.netlify.app/';
        const imagenUrl = document.getElementById('banner-rifas-imagen-url').value || 'https://via.placeholder.com/1200x300/FF6B35/ffffff?text=PARTICIPA+EN+NUESTRAS+RIFAS+ONLINE';
        const activo = document.getElementById('banner-rifas-activo').checked;
        
        const datosBanner = {
          tipo: 'rifas',
          titulo: titulo,
          descripcion: descripcion,
          enlace: enlace,
          imagen: imagenUrl,
          activo: activo,
          orden: 2
        };

        console.log('üì§ Guardando banner rifas:', datosBanner);
        const bannerGuardado = await Banner.crearOActualizar(datosBanner);
        
        actualizarInfoBannerRifas(bannerGuardado);
        mostrarNotificacion('‚úÖ Banner de rifas guardado correctamente');
        
      } catch (error) {
        console.error('‚ùå Error guardando banner de rifas:', error);
        mostrarNotificacion('‚ùå Error al guardar el banner de rifas: ' + error.message, 'error');
      } finally {
        btnGuardar.innerHTML = estadoOriginal;
        btnGuardar.disabled = false;
      }
    });

    // Restaurar valores predeterminados del banner de oferta
    async function restaurarBannerOfertaDefault() {
      if (confirm('¬øRestaurar valores predeterminados del banner de oferta?')) {
        try {
          document.getElementById('banner-oferta-titulo').value = 'Oferta Especial';
          document.getElementById('banner-oferta-descripcion').value = 'Descuentos hasta 50%';
          document.getElementById('banner-oferta-enlace').value = 'https://wa.me/5493624840349?text=Quiero%20la%20oferta%20del%20d√≠a';
          document.getElementById('banner-oferta-activo').checked = true;
          document.getElementById('banner-oferta-imagen-url').value = 'img/banner-oferta.jpg';
          
          document.getElementById('banner-oferta-preview').src = 'img/banner-oferta.jpg';
          document.getElementById('banner-oferta-preview').style.display = 'block';
          
          mostrarNotificacion('‚úÖ Valores predeterminados restaurados. Recuerda guardar los cambios.');
          
        } catch (error) {
          console.error('Error restaurando banner de oferta:', error);
          mostrarNotificacion('Error al restaurar valores predeterminados', 'error');
        }
      }
    }

    // Restaurar valores predeterminados del banner de rifas
    async function restaurarBannerRifasDefault() {
      if (confirm('¬øRestaurar valores predeterminados del banner de rifas?')) {
        try {
          document.getElementById('banner-rifas-titulo').value = 'üéâ ¬°Participa en Nuestras Rifas! üéâ';
          document.getElementById('banner-rifas-descripcion').value = 'Gana premios incre√≠bles - ¬°Es muy f√°cil participar!';
          document.getElementById('banner-rifas-enlace').value = 'https://rifasapponline.netlify.app/';
          document.getElementById('banner-rifas-activo').checked = true;
          document.getElementById('banner-rifas-imagen-url').value = 'https://via.placeholder.com/1200x300/FF6B35/ffffff?text=PARTICIPA+EN+NUESTRAS+RIFAS+ONLINE';
          
          document.getElementById('banner-rifas-preview').src = 'https://via.placeholder.com/1200x300/FF6B35/ffffff?text=PARTICIPA+EN+NUESTRAS+RIFAS+ONLINE';
          document.getElementById('banner-rifas-preview').style.display = 'block';
          
          mostrarNotificacion('‚úÖ Valores predeterminados restaurados. Recuerda guardar los cambios.');
          
        } catch (error) {
          console.error('Error restaurando banner de rifas:', error);
          mostrarNotificacion('Error al restaurar valores predeterminados', 'error');
        }
      }
    }

    // Desactivar banner de rifas
    async function desactivarBannerRifas() {
      if (confirm('¬øDesactivar el banner de rifas? No se mostrar√° en la tienda.')) {
        try {
          document.getElementById('banner-rifas-activo').checked = false;
          
          // Guardar autom√°ticamente el cambio
          const datosBanner = {
            tipo: 'rifas',
            titulo: document.getElementById('banner-rifas-titulo').value,
            descripcion: document.getElementById('banner-rifas-descripcion').value,
            enlace: document.getElementById('banner-rifas-enlace').value,
            imagen: document.getElementById('banner-rifas-imagen-url').value,
            activo: false,
            orden: 2
          };

          await Banner.crearOActualizar(datosBanner);
          
          const bannerRifas = await Banner.obtenerBannerPorTipo('rifas');
          actualizarInfoBannerRifas(bannerRifas);
          
          mostrarNotificacion('‚úÖ Banner de rifas desactivado correctamente');
          
        } catch (error) {
          console.error('Error desactivando banner de rifas:', error);
          mostrarNotificacion('Error al desactivar el banner de rifas', 'error');
        }
      }
    }

    // =============================================
    // SISTEMA DE CONFIGURACI√ìN
    // =============================================

    // Cargar configuraci√≥n actual
    async function cargarConfiguracionActual() {
      try {
        const config = await Configuracion.obtener();
        if (config) {
          document.getElementById('config-nombre').value = config.get('nombreTienda') || 'PuntoAlmacen';
          document.getElementById('config-whatsapp').value = config.get('whatsapp') || '5493624840349';
          document.getElementById('config-direccion').value = config.get('direccion') || 'Calle Falsa 123, Ciudad';
          document.getElementById('config-horarios').value = config.get('horarios') || 'L a V 9-18 hs';
          document.getElementById('config-mensaje').value = config.get('mensajeWhatsApp') || 'Hola PuntoAlmacen, quiero hacer un pedido';
          document.getElementById('config-envio-gratis').value = config.get('minimoEnvioGratis') || 10000;
          document.getElementById('config-costo-envio').value = config.get('costoEnvio') || 800;
        }
      } catch (error) {
        console.error('Error cargando configuraci√≥n:', error);
      }
    }

    // Formulario de configuraci√≥n
    document.getElementById('form-configuracion').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btnGuardar = this.querySelector('button[type="submit"]');
      const estadoOriginal = btnGuardar.innerHTML;
      
      btnGuardar.innerHTML = 'üíæ Guardando...';
      btnGuardar.disabled = true;
      
      try {
        const datosConfig = {
          nombreTienda: document.getElementById('config-nombre').value,
          whatsapp: document.getElementById('config-whatsapp').value,
          direccion: document.getElementById('config-direccion').value,
          horarios: document.getElementById('config-horarios').value,
          mensajeWhatsApp: document.getElementById('config-mensaje').value,
          minimoEnvioGratis: parseInt(document.getElementById('config-envio-gratis').value),
          costoEnvio: parseInt(document.getElementById('config-costo-envio').value)
        };

        await Configuracion.crearOActualizar(datosConfig);
        mostrarNotificacion('‚úÖ Configuraci√≥n guardada correctamente');
        
      } catch (error) {
        console.error('Error guardando configuraci√≥n:', error);
        mostrarNotificacion('‚ùå Error al guardar la configuraci√≥n: ' + error.message, 'error');
      } finally {
        btnGuardar.innerHTML = estadoOriginal;
        btnGuardar.disabled = false;
      }
    });

    // =============================================
    // SISTEMA DE UPLOAD DE ARCHIVOS
    // =============================================

    function inicializarUploads() {
      // Upload de banner oferta
      document.getElementById('banner-oferta-file').addEventListener('change', function(e) {
        bannerOfertaFile = e.target.files[0];
        if (bannerOfertaFile) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('banner-oferta-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('banner-oferta-imagen-url').value = e.target.result;
            document.getElementById('banner-oferta-status').textContent = `‚úÖ Imagen cargada: ${bannerOfertaFile.name} (${Math.round(bannerOfertaFile.size/1024)} KB)`;
          };
          reader.readAsDataURL(bannerOfertaFile);
        }
      });

      // Upload de banner rifas
      document.getElementById('banner-rifas-file').addEventListener('change', function(e) {
        bannerRifasFile = e.target.files[0];
        if (bannerRifasFile) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('banner-rifas-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('banner-rifas-imagen-url').value = e.target.result;
            document.getElementById('banner-rifas-status').textContent = `‚úÖ Imagen cargada: ${bannerRifasFile.name} (${Math.round(bannerRifasFile.size/1024)} KB)`;
          };
          reader.readAsDataURL(bannerRifasFile);
        }
      });

      // Upload de producto
      document.getElementById('producto-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('producto-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('producto-imagen-url').value = e.target.result;
            document.getElementById('producto-status').textContent = `‚úÖ Imagen cargada: ${file.name}`;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // =============================================
    // FUNCIONES DE PRODUCTOS Y PEDIDOS
    // =============================================

    // Cargar productos
    async function cargarProductos() {
      const loadingDiv = document.getElementById('productos-loading');
      const tablaProductos = document.getElementById('tabla-productos');
      
      loadingDiv.style.display = 'block';
      
      try {
        const productos = await Producto.obtenerTodos();
        
        if (productos.length === 0) {
          tablaProductos.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay productos activos</td></tr>';
        } else {
          tablaProductos.innerHTML = productos.map(producto => `
            <tr>
              <td>${producto.id}</td>
              <td>
                <img src="${producto.get('imagen')}" alt="${producto.get('nombre')}" 
                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" 
                     onerror="this.src='https://via.placeholder.com/50x50/25D366/ffffff?text=IMG'">
              </td>
              <td>${producto.get('nombre')}</td>
              <td>$${producto.get('precio')}</td>
              <td>${producto.get('categoria')}</td>
              <td>${producto.get('destacado') ? '‚≠ê' : ''}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="eliminarProducto('${producto.id}')">Eliminar</button>
              </td>
            </tr>
          `).join('');
        }
        
      } catch (error) {
        console.error('Error cargando productos:', error);
        tablaProductos.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc3545;">Error al cargar los productos</td></tr>';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Formulario de producto
    document.getElementById('form-producto').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const loadingDiv = document.getElementById('producto-loading');
      const submitBtn = this.querySelector('button[type="submit"]');
      
      loadingDiv.style.display = 'block';
      submitBtn.disabled = true;
      
      try {
        const imagenUrl = document.getElementById('producto-imagen-url').value || 'https://via.placeholder.com/300x250/25D366/ffffff?text=Producto';
        
        const datosProducto = {
          nombre: document.getElementById('producto-nombre').value,
          precio: document.getElementById('producto-precio').value,
          categoria: document.getElementById('producto-categoria').value,
          imagen: imagenUrl,
          descripcion: document.getElementById('producto-descripcion').value,
          destacado: document.getElementById('producto-destacado').checked
        };

        await Producto.crear(datosProducto);
        
        // Resetear formulario
        this.reset();
        document.getElementById('producto-preview').style.display = 'none';
        document.getElementById('producto-status').textContent = '';
        
        // Recargar lista
        await cargarProductos();
        await cargarDashboard();
        
        mostrarNotificacion('‚úÖ Producto agregado correctamente');
        
      } catch (error) {
        console.error('Error guardando producto:', error);
        mostrarNotificacion('‚ùå Error al guardar el producto: ' + error.message, 'error');
      } finally {
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    // Eliminar producto
    async function eliminarProducto(id) {
      if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
        try {
          await Producto.eliminar(id);
          await cargarProductos();
          await cargarDashboard();
          mostrarNotificacion('‚úÖ Producto eliminado correctamente');
        } catch (error) {
          console.error('Error eliminando producto:', error);
          mostrarNotificacion('‚ùå Error al eliminar el producto', 'error');
        }
      }
    }

    // Cargar pedidos
    async function cargarPedidos() {
      const loadingDiv = document.getElementById('pedidos-loading');
      const tablaPedidos = document.getElementById('tabla-pedidos');
      const tablaPedidosRecientes = document.getElementById('tabla-pedidos-recientes');
      
      loadingDiv.style.display = 'block';
      
      try {
        const pedidos = await Pedido.obtenerTodos();
        const pedidosRecientes = await Pedido.obtenerRecientes(5);
        
        // Actualizar tabla principal de pedidos
        if (pedidos.length === 0) {
          tablaPedidos.innerHTML = '<tr><td colspan="9" style="text-align: center;">No hay pedidos registrados</td></tr>';
        } else {
          tablaPedidos.innerHTML = pedidos.map(pedido => `
            <tr>
              <td>${pedido.id}</td>
              <td>
                <strong>${pedido.get('cliente') || 'Cliente'}</strong><br>
                <small>${pedido.get('telefono') || 'Sin tel√©fono'}</small>
              </td>
              <td>
                ${Array.isArray(pedido.get('productos')) ? 
                  pedido.get('productos').map(p => `${p.nombre} x${p.cantidad}`).join('<br>') : 
                  'Sin productos'}
              </td>
              <td>$${pedido.get('subtotal') || 0}</td>
              <td>${pedido.get('envio') === 0 ? '<span style="color: #25D366;">GRATIS</span>' : `$${pedido.get('envio') || 0}`}</td>
              <td>$${pedido.get('total') || 0}</td>
              <td><span class="estado-${pedido.get('estado') || 'pendiente'}">${pedido.get('estado') || 'pendiente'}</span></td>
              <td>${new Date(pedido.createdAt).toLocaleDateString()}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="verPedido('${pedido.id}')">Detalles</button>
              </td>
            </tr>
          `).join('');
        }
        
        // Actualizar tabla de pedidos recientes en dashboard
        if (pedidosRecientes.length === 0) {
          tablaPedidosRecientes.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay pedidos recientes</td></tr>';
        } else {
          tablaPedidosRecientes.innerHTML = pedidosRecientes.map(pedido => `
            <tr>
              <td>${pedido.id}</td>
              <td>${pedido.get('cliente') || 'Cliente'}</td>
              <td>$${pedido.get('total') || 0}</td>
              <td><span class="estado-${pedido.get('estado') || 'pendiente'}">${pedido.get('estado') || 'pendiente'}</span></td>
              <td>${new Date(pedido.createdAt).toLocaleDateString()}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="verPedido('${pedido.id}')">Ver</button>
              </td>
            </tr>
          `).join('');
        }
        
      } catch (error) {
        console.error('Error cargando pedidos:', error);
        tablaPedidos.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #dc3545;">Error al cargar los pedidos</td></tr>';
        tablaPedidosRecientes.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">Error al cargar pedidos</td></tr>';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Ver detalles del pedido
    async function verPedido(id) {
      try {
        const query = new Parse.Query(Pedido);
        const pedido = await query.get(id);
        
        let mensaje = `üõçÔ∏è Detalles del Pedido #${pedido.id}\n\n`;
        mensaje += `üë§ Cliente: ${pedido.get('cliente') || 'No especificado'}\n`;
        mensaje += `üìû Tel√©fono: ${pedido.get('telefono') || 'No especificado'}\n`;
        mensaje += `üìç Direcci√≥n: ${pedido.get('direccion') || 'No especificada'}\n\n`;
        mensaje += `üì¶ Productos:\n`;
        
        if (Array.isArray(pedido.get('productos'))) {
          pedido.get('productos').forEach(p => {
            mensaje += `   ‚Ä¢ ${p.nombre} x${p.cantidad} - $${p.precio * p.cantidad}\n`;
          });
        }
        
        mensaje += `\nüí∞ Subtotal: $${pedido.get('subtotal') || 0}\n`;
        mensaje += `üöö Env√≠o: ${pedido.get('envio') === 0 ? 'GRATIS' : `$${pedido.get('envio')}`}\n`;
        mensaje += `üíµ Total: $${pedido.get('total') || 0}\n\n`;
        mensaje += `üìÖ Fecha: ${new Date(pedido.createdAt).toLocaleString()}\n`;
        mensaje += `üìã Estado: ${pedido.get('estado') || 'pendiente'}`;
        
        alert(mensaje);
      } catch (error) {
        console.error('Error viendo pedido:', error);
        mostrarNotificacion('‚ùå Error al cargar los detalles del pedido', 'error');
      }
    }

    // Cargar dashboard
    async function cargarDashboard() {
      try {
        const pedidos = await Pedido.obtenerTodos();
        const productos = await Producto.obtenerTodos();
        
        // Calcular estad√≠sticas
        const totalVentas = pedidos.reduce((sum, pedido) => sum + (pedido.get('total') || 0), 0);
        const hoy = new Date().toDateString();
        const pedidosHoy = pedidos.filter(pedido => 
          new Date(pedido.createdAt).toDateString() === hoy
        ).length;
        const pedidosPendientes = pedidos.filter(pedido => 
          pedido.get('estado') === 'pendiente'
        ).length;

        // Actualizar UI
        document.getElementById('total-ventas').textContent = `$${totalVentas}`;
        document.getElementById('total-pedidos').textContent = pedidosHoy;
        document.getElementById('total-productos').textContent = productos.length;
        document.getElementById('pedidos-pendientes').textContent = pedidosPendientes;

      } catch (error) {
        console.error('Error cargando dashboard:', error);
      }
    }

    // =============================================
    // FUNCIONES UTILITARIAS
    // =============================================

    // Mostrar notificaci√≥n
    function mostrarNotificacion(mensaje, tipo = 'success') {
      const notificacion = document.createElement('div');
      notificacion.className = `notificacion ${tipo === 'error' ? 'error' : ''}`;
      notificacion.textContent = mensaje;
      
      document.body.appendChild(notificacion);

      setTimeout(() => {
        if (document.body.contains(notificacion)) {
          document.body.removeChild(notificacion);
        }
      }, 3000);
    }

    // Navegaci√≥n entre secciones
    document.querySelectorAll('.nav-admin li').forEach(item => {
      item.addEventListener('click', function() {
        document.querySelectorAll('.nav-admin li').forEach(li => li.classList.remove('active'));
        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        
        this.classList.add('active');
        const sectionId = this.getAttribute('data-section');
        document.getElementById(sectionId).classList.add('active');
        document.getElementById('section-title').textContent = this.textContent.trim();
        
        // Cargar datos espec√≠ficos cuando se accede a una secci√≥n
        if (sectionId === 'banners') {
          cargarBannersActuales();
        } else if (sectionId === 'dashboard') {
          cargarDashboard();
        }
      });
    });

    // =============================================
    // INICIALIZACI√ìN
    // =============================================
    
    // Verificar sesi√≥n al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      verificarSesion();
    });

  </script>
</body>
</html>